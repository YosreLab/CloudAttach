name: Create Release Package

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create plugin package
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p CloudAttach

          # å¤åˆ¶æ’ä»¶éœ€è¦çš„æ–‡ä»¶
          cp Plugin.php CloudAttach/
          cp handler.php CloudAttach/
          cp Action.php CloudAttach/
          cp CosUploader.php CloudAttach/
          cp README.md CloudAttach/

          # å¤åˆ¶ lib ç›®å½•
          cp -r lib CloudAttach/

          # åˆ›å»ºå‹ç¼©åŒ…
          zip -r CloudAttach-${GITHUB_REF#refs/tags/}.zip CloudAttach

          # æ˜¾ç¤ºå‹ç¼©åŒ…å†…å®¹
          echo "å‹ç¼©åŒ…å†…å®¹ï¼š"
          unzip -l CloudAttach-${GITHUB_REF#refs/tags/}.zip

      - name: Get tag message
        id: tag_message
        run: |
          TAG_MESSAGE=$(git tag -l --format='%(contents)' ${{ github.ref_name }})
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$TAG_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: CloudAttach-*.zip
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ${{ steps.tag_message.outputs.message }}

            ---

            ## ğŸ“¦ å®‰è£…è¯´æ˜

            1. ä¸‹è½½ä¸‹æ–¹çš„ `CloudAttach-${{ github.ref_name }}.zip` æ–‡ä»¶
            2. è§£å‹åå°† `CloudAttach` æ–‡ä»¶å¤¹ä¸Šä¼ åˆ° Typecho çš„ `usr/plugins/` ç›®å½•
            3. åœ¨ Typecho åå°å¯ç”¨æ’ä»¶
            4. é…ç½®è…¾è®¯äº‘ COS å‚æ•°

            ## âœ¨ ä¸»è¦åŠŸèƒ½

            - âœ… è…¾è®¯äº‘ COS å¯¹è±¡å­˜å‚¨æ”¯æŒ
            - âœ… æ‰¹é‡ä¸Šä¼ åŠŸèƒ½ï¼ˆæœ€å¤šå¹¶å‘ 3 ä¸ªæ–‡ä»¶ï¼‰
            - âœ… ä¸Šä¼ é˜Ÿåˆ—å¯è§†åŒ–ç®¡ç†
            - âœ… å®æ—¶ä¸Šä¼ è¿›åº¦æ˜¾ç¤º
            - âœ… å¤šé€‰åŠŸèƒ½å’Œæ‰¹é‡æ“ä½œ
            - âœ… æ–‡ä»¶åˆ†ç±»ç­›é€‰
            - âœ… åˆ†é¡µæµè§ˆé™„ä»¶
            - âœ… å›¾ç‰‡é¢„è§ˆåŠŸèƒ½

            ---

            **å®Œæ•´æ–‡æ¡£**: [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
